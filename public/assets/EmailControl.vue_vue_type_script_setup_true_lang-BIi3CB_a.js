import{T as J,u as j}from"./useEmailTemplates-pTnWQzTM.js";import{R as z,O as $,i as q,M as C,n as E,D as H,L as W,r,C as Y,w as Q,H as X,f as l,v as a,G as U,x as T,q as A,A as D,U as Z}from"./index-HJU8uDYG.js";import{_ as ee}from"./ModelDialog.vue_vue_type_script_setup_true_lang-b5OV-xC6.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as K}from"./forwardRefs-C1LdfB5U.js";import{a as w,V as k}from"./VRow-7yqZIZlR.js";import{V as te}from"./VSelect-DyYItzJC.js";import{V as S,o as ae}from"./VGrid-lnm4LJRy.js";import{a as se,V as oe}from"./VAlert-C2ij2ema.js";import{V as L}from"./VList-BHjq3SM0.js";import{e as ne,V as ie,a as ue,c as re}from"./VCard-Bt_v7nkS.js";import{V as de}from"./VOverlay-BGfPd9at.js";import{V as me}from"./VSpacer-C4HJrKsx.js";var ve=(s=>(s.CHECK_IN_STATUS_PENDING="CHECK_IN_STATUS_PENDING",s.CHECK_IN_STATUS_COMPLETED="CHECK_IN_STATUS_COMPLETED",s.CHECK_IN_STATUS_REJECTED="CHECK_IN_STATUS_REJECTED",s.CHECK_IN_STATUS_REVOKED="CHECK_IN_STATUS_REVOKED",s))(ve||{});const fe=[{title:"Pending",value:"CHECK_IN_STATUS_PENDING"},{title:"Completed",value:"CHECK_IN_STATUS_COMPLETED"},{title:"Rejected",value:"CHECK_IN_STATUS_REJECTED"},{title:"Revoked",value:"CHECK_IN_STATUS_REVOKED"}],Ae=s=>{var n;return((n=fe.find(i=>i.value===s))==null?void 0:n.title)||""},O=new Map;async function ce(){var V;const s=$(),i=((V=z().params.convention)==null?void 0:V.toString())||"";if(!i)return;const d=O.get(i);if(!d||!d.value||d.timestamp<Date.now()-1e3*60*5)try{const c=await s.getConvention(i);return O.set(i,{timestamp:Date.now(),value:c}),c}catch{return}return d.value}const pe=["innerHTML"],Te=q({__name:"EmailPreviewWindow",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(s){const n=C(s,"modelValue");return(i,d)=>(E(),H("div",{innerHTML:n.value,class:"reset-styles"},null,8,pe))}}),Ee=le(Te,[["__scopeId","data-v-a08129c7"]]),Ue={class:"d-flex align-center justify-center",style:{width:"calc(100vw - 25px)",height:"100vh"}},He=q({__name:"EmailControl",props:W({modelType:{default:"user"}},{modelValue:{default:[]},modelModifiers:{},details:{required:!1},detailsModifiers:{},convention:{required:!1,default:void 0},conventionModifiers:{},organisation:{required:!1,default:void 0},organisationModifiers:{}}),emits:["update:modelValue","update:details","update:convention","update:organisation"],async setup(s){let n,i;const d=$(),{getEmailTemplateList:V}=j(),c=r([]),u=r(),g=C(s,"modelValue"),N=C(s,"details"),p=C(s,"convention");p.value||(p.value=([n,i]=Y(()=>ce()),n=await n,i(),n));const y=C(s,"organisation"),v=r(0),f=r([]),P=r(!1),_=r(!1),b=r(0),I=r(0),m=r([]),M=()=>{var o,e;V(J.TARGET_TYPE_CONVENTION,((o=y.value)==null?void 0:o.OrganisationUUID)||null,((e=p.value)==null?void 0:e.ConventionUUID)||null).then(t=>{c.value=t})};Q(p,()=>{M()}),M();const x=o=>{var t;const e={};return s.modelType=="registration"?e.RegistrationUUID=o:s.modelType=="submission"?e.SubmissionUUID=o:e.UserUUID=o,p.value&&(e.ConventionUUID=p.value.ConventionUUID),y.value&&(e.OrganisationUUID=y.value.OrganisationUUID),u.value&&(u.value.IsDefault?e.TemplateName=u.value.Name:((t=u.value)==null?void 0:t.EmailTemplateUUID)!==Z?e.TemplateUUID=u.value.EmailTemplateUUID:e.Template=u.value),e},G=()=>{f.value=[],g.value.forEach(o=>{const e=x(o);d.previewEmailTemplate(e).then(t=>{f.value.push(t)})}),P.value=!0};function B(o){return new Promise(e=>setTimeout(e,o))}const h=async()=>{_.value=!0,b.value=0,I.value=0,m.value=[];for(const o of g.value){const e=x(o);try{await d.sendEmailTemplate(e)}catch{if(e.RegistrationUUID&&N.value&&N.value.length>0){const R=N.value.find(F=>F.RegistrationUUID==e.RegistrationUUID);R?m.value.push(`Failed to send to: #${R.Reference} - ${R.Name}`):m.value.push(`Failed to send to: UUID ${e.RegistrationUUID}`)}else m.value.push(`Failed to send to: UUID ${e.RegistrationUUID}`)}await B(50),b.value+=1,I.value=b.value/g.value.length*100}_.value=!1};return(o,e)=>(E(),H("div",null,[g.value.length>0?(E(),H(X,{key:0},[l(k,null,{default:a(()=>[l(w,null,{default:a(()=>e[7]||(e[7]=[U("h2",null,"E-Mail",-1),U("p",null," Select an e-mail template to send bulk e-mails to selected registrations. You may preview what is sent before queuing it. ",-1)])),_:1})]),_:1}),l(k,null,{default:a(()=>[l(w,{cols:"12",sm:"7"},{default:a(()=>[l(te,{modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=t=>u.value=t),items:c.value,"item-value":t=>t,"item-title":"Title","hide-details":"",clearable:""},null,8,["modelValue","items","item-value"])]),_:1}),l(w,{cols:"6",sm:"3"},{default:a(()=>[l(S,{color:"primary",disabled:!u.value,onClick:G,class:"w-100"},{default:a(()=>e[8]||(e[8]=[T(" Preview ")])),_:1},8,["disabled"])]),_:1}),l(w,{cols:"6",sm:"2",class:"text-right text-sm-left"},{default:a(()=>[l(S,{color:"success",disabled:!u.value,onClick:h,class:"w-100"},{default:a(()=>e[9]||(e[9]=[T(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1}),m.value.length?(E(),A(oe,{key:0,color:"error",class:"mt-4"},{default:a(()=>[l(se,null,{default:a(()=>e[10]||(e[10]=[T("Errors Encountered")])),_:1}),l(L,{items:m.value,class:"mt-4 rounded"},null,8,["items"])]),_:1})):D("",!0),l(de,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=t=>_.value=t),"scroll-strategy":"block","location-strategy":"static","close-on-content-click":!1},{default:a(()=>[U("div",Ue,[e[13]||(e[13]=T(" > ")),l(ne,{class:"ma-0",bordered:""},{default:a(()=>[l(ie,null,{default:a(()=>[l(ue,{class:"text-center"},{default:a(()=>e[11]||(e[11]=[U("small",null,"Sending Emails",-1)])),_:1})]),_:1}),l(re,{class:"text-center"},{default:a(()=>[l(ae,{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=t=>I.value=t),color:"error",size:"60",width:"8"},null,8,["modelValue"]),e[12]||(e[12]=U("p",{class:"my-4"}," Navigating away will prevent emails from sending. ",-1)),m.value.length?(E(),A(L,{key:0,items:m.value},null,8,["items"])):D("",!0)]),_:1})]),_:1})])]),_:1},8,["modelValue"]),l(ee,{modelValue:P.value,"onUpdate:modelValue":e[6]||(e[6]=t=>P.value=t),fullscreen:!1,"hide-details":!0,title:"Email Preview",scrollable:!0},{actions:a(()=>[l(K,null,{default:a(()=>[l(S,{color:"primary",disabled:v.value==0,onClick:e[3]||(e[3]=t=>v.value-=1)},{default:a(()=>e[14]||(e[14]=[T(" Previous ")])),_:1},8,["disabled"])]),_:1}),l(me),l(K,null,{default:a(()=>[l(S,{color:"primary",disabled:v.value==f.value.length-1,onClick:e[4]||(e[4]=t=>v.value+=1)},{default:a(()=>e[15]||(e[15]=[T(" Next ")])),_:1},8,["disabled"])]),_:1})]),default:a(()=>[f.value.length>0&&f.value[v.value]?(E(),A(Ee,{key:0,modelValue:f.value[v.value].HTML,"onUpdate:modelValue":e[5]||(e[5]=t=>f.value[v.value].HTML=t)},null,8,["modelValue"])):D("",!0)]),_:1},8,["modelValue"])],64)):D("",!0)]))}});export{fe as C,He as _,Ae as a,ve as b,ce as u};
