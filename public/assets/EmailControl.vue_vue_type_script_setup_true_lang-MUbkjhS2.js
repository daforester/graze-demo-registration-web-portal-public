import{_ as Z,T as q,u as h}from"./EmailEditor.vue_vue_type_script_setup_true_lang-D72J9z3t.js";import{R as ee,N as Y,i as z,M as D,D as H,n as f,L as le,r as n,C as ae,w as te,A as C,h as a,H as B,l as I,q as t,G as _,v as u,F as se,U as oe,k as ie}from"./index-CPQG3ksL.js";import{_ as ne}from"./ModelDialog.vue_vue_type_script_setup_true_lang-DG5PG31b.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as F}from"./forwardRefs-iLiBNF3X.js";import{V as K,a as c}from"./VRow-Bfk37D86.js";import{V as re}from"./VSelect-CrRUXP-G.js";import{V as v,o as de}from"./VGrid-DS3sCdVn.js";import{V as me,a as ve}from"./VAlert-DnaIzoXj.js";import{V as j}from"./VList-ScwP36zQ.js";import{V as fe}from"./VOverlay-DLMi69ST.js";import{e as pe,V as Te,a as ce,c as Ee}from"./VCard-Z3iiRnN2.js";import{V as Ce}from"./VSpacer-B-gJ86X_.js";import{V as Ue}from"./SaveButton.vue_vue_type_script_setup_true_lang-KszHEOUC.js";var Ve=(s=>(s.CHECK_IN_STATUS_PENDING="CHECK_IN_STATUS_PENDING",s.CHECK_IN_STATUS_COMPLETED="CHECK_IN_STATUS_COMPLETED",s.CHECK_IN_STATUS_REJECTED="CHECK_IN_STATUS_REJECTED",s.CHECK_IN_STATUS_REVOKED="CHECK_IN_STATUS_REVOKED",s))(Ve||{});const ge=[{title:"Pending",value:"CHECK_IN_STATUS_PENDING"},{title:"Completed",value:"CHECK_IN_STATUS_COMPLETED"},{title:"Rejected",value:"CHECK_IN_STATUS_REJECTED"},{title:"Revoked",value:"CHECK_IN_STATUS_REVOKED"}],Ge=s=>{var r;return((r=ge.find(d=>d.value===s))==null?void 0:r.title)||""},J=new Map;async function we(){var S;const s=Y(),d=((S=ee().params.convention)==null?void 0:S.toString())||"";if(!d)return;const p=J.get(d);if(!p||!p.value||p.timestamp<Date.now()-1e3*60*5)try{const U=await s.getConvention(d);return J.set(d,{timestamp:Date.now(),value:U}),U}catch{return}return p.value}const Ie=["innerHTML"],_e=z({__name:"EmailPreviewWindow",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(s){const r=D(s,"modelValue");return(d,p)=>(f(),H("div",{innerHTML:r.value,class:"reset-styles"},null,8,Ie))}}),De=ue(_e,[["__scopeId","data-v-a08129c7"]]),Se={class:"d-flex align-center justify-center",style:{width:"calc(100vw - 25px)",height:"100vh"}},qe=z({__name:"EmailControl",props:le({modelType:{default:"user"},custom:{type:Boolean,default:!1}},{modelValue:{default:[]},modelModifiers:{},details:{required:!1},detailsModifiers:{},convention:{required:!1,default:void 0},conventionModifiers:{},organisation:{required:!1,default:void 0},organisationModifiers:{}}),emits:["update:modelValue","update:details","update:convention","update:organisation"],async setup(s){let r,d;const p=Y(),{getEmailTemplateList:S}=h(),U=n([]),i=n(),y=D(s,"modelValue"),M=D(s,"details"),V=D(s,"convention");V.value||(V.value=([r,d]=ae(()=>we()),r=await r,d(),r));const R=D(s,"organisation"),T=n(0),E=n([]),A=n(!1),N=n(!1),x=n(0),b=n(0),m=n([]),g=n(!1),k=n(""),P=n(!1),L=()=>{var o,e;S(q.TARGET_TYPE_CONVENTION,((o=R.value)==null?void 0:o.OrganisationUUID)||null,((e=V.value)==null?void 0:e.ConventionUUID)||null).then(l=>{U.value=l})};te(V,()=>{L()}),L();const O=(o,e=!1)=>{var w;const l={};return s.modelType=="registration"?l.RegistrationUUID=o:s.modelType=="submission"?l.SubmissionUUID=o:l.UserUUID=o,V.value&&(l.ConventionUUID=V.value.ConventionUUID),R.value&&(l.OrganisationUUID=R.value.OrganisationUUID),i.value&&(i.value.IsDefault?l.TemplateName=i.value.Name:((w=i.value)==null?void 0:w.EmailTemplateUUID)!==oe?l.TemplateUUID=i.value.EmailTemplateUUID:l.Template=i.value),e&&(l.Template=ie(i.value),l.TemplateUUID=void 0,l.TemplateName=void 0,l.Template&&(l.Template.HTML=k.value)),l},$=()=>{E.value=[],y.value.forEach(o=>{const e=O(o,g.value);p.previewEmailTemplate(e).then(l=>{E.value.push(l)})}),T.value=0,A.value=!0};function W(o){return new Promise(e=>setTimeout(e,o))}const G=async()=>{N.value=!0,x.value=0,b.value=0,m.value=[];for(const o of y.value){const e=O(o,g.value);try{await p.sendEmailTemplate(e)}catch{if(e.RegistrationUUID&&M.value&&M.value.length>0){const w=M.value.find(X=>X.RegistrationUUID==e.RegistrationUUID);w?m.value.push(`Failed to send to: #${w.Reference} - ${w.Name}`):m.value.push(`Failed to send to: UUID ${e.RegistrationUUID}`)}else m.value.push(`Failed to send to: UUID ${e.RegistrationUUID}`)}await W(50),x.value+=1,b.value=x.value/y.value.length*100}N.value=!1,m.value.length===0&&(P.value=!0)},Q=async()=>{var o;k.value=((o=i.value)==null?void 0:o.HTML)||"",g.value=!0};return(o,e)=>(f(),H("div",null,[y.value.length>0?(f(),H(B,{key:0},[a(K,null,{default:t(()=>[a(c,null,{default:t(()=>e[11]||(e[11]=[_("h2",null,"E-Mail",-1),_("p",null," Select an e-mail template to send bulk e-mails to selected registrations. You may preview what is sent before queuing it. ",-1)])),_:1})]),_:1}),g.value?C("",!0):(f(),I(K,{key:0},{default:t(()=>[a(c,{cols:"12",md:"6"},{default:t(()=>[a(re,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=l=>i.value=l),items:U.value,"item-value":l=>l,"item-title":"Title","hide-details":"",clearable:""},null,8,["modelValue","items","item-value"])]),_:1}),o.custom?(f(),I(c,{key:0,cols:"4",md:"2"},{default:t(()=>[a(v,{color:"warning",disabled:!i.value,onClick:Q,class:"w-100"},{default:t(()=>e[12]||(e[12]=[u(" Customise ")])),_:1},8,["disabled"])]),_:1})):C("",!0),a(c,{cols:"4",md:"2"},{default:t(()=>[a(v,{color:"primary",disabled:!i.value,onClick:$,class:"w-100"},{default:t(()=>e[13]||(e[13]=[u(" Preview ")])),_:1},8,["disabled"])]),_:1}),a(c,{cols:"4",md:"2",class:"text-right text-sm-left"},{default:t(()=>[a(v,{color:"success",disabled:!i.value,onClick:G,class:"w-100"},{default:t(()=>e[14]||(e[14]=[u(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1})),m.value.length?(f(),I(me,{key:1,color:"error",class:"mt-4"},{default:t(()=>[a(ve,null,{default:t(()=>e[15]||(e[15]=[u("Errors Encountered")])),_:1}),a(j,{items:m.value,class:"mt-4 rounded"},null,8,["items"])]),_:1})):C("",!0),a(fe,{modelValue:N.value,"onUpdate:modelValue":e[2]||(e[2]=l=>N.value=l),"scroll-strategy":"block","location-strategy":"static","close-on-content-click":!1},{default:t(()=>[_("div",Se,[e[18]||(e[18]=u(" > ")),a(pe,{class:"ma-0",bordered:""},{default:t(()=>[a(Te,null,{default:t(()=>[a(ce,{class:"text-center"},{default:t(()=>e[16]||(e[16]=[_("small",null,"Sending Emails",-1)])),_:1})]),_:1}),a(Ee,{class:"text-center"},{default:t(()=>[a(de,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=l=>b.value=l),color:"error",size:"60",width:"8"},null,8,["modelValue"]),e[17]||(e[17]=_("p",{class:"my-4"}," Navigating away will prevent emails from sending. ",-1)),m.value.length?(f(),I(j,{key:0,items:m.value},null,8,["items"])):C("",!0)]),_:1})]),_:1})])]),_:1},8,["modelValue"]),a(ne,{modelValue:A.value,"onUpdate:modelValue":e[6]||(e[6]=l=>A.value=l),fullscreen:!1,"hide-details":!0,title:"Email Preview",scrollable:!0},{actions:t(()=>[a(F,null,{default:t(()=>[a(v,{color:"primary",disabled:T.value==0,onClick:e[3]||(e[3]=l=>T.value-=1)},{default:t(()=>e[19]||(e[19]=[u(" Previous ")])),_:1},8,["disabled"])]),_:1}),a(Ce),a(F,null,{default:t(()=>[a(v,{color:"primary",disabled:T.value==E.value.length-1,onClick:e[4]||(e[4]=l=>T.value+=1)},{default:t(()=>e[20]||(e[20]=[u(" Next ")])),_:1},8,["disabled"])]),_:1})]),default:t(()=>[E.value.length>0&&E.value[T.value]?(f(),I(De,{key:0,modelValue:E.value[T.value].HTML,"onUpdate:modelValue":e[5]||(e[5]=l=>E.value[T.value].HTML=l)},null,8,["modelValue"])):C("",!0)]),_:1},8,["modelValue"])],64)):C("",!0),g.value?(f(),H(B,{key:1},[a(Z,{modelValue:k.value,"onUpdate:modelValue":e[7]||(e[7]=l=>k.value=l),"owner-type":se(q).TARGET_TYPE_CONVENTION},null,8,["modelValue","owner-type"]),a(K,{class:"justify-end"},{default:t(()=>[a(c,{cols:"4",sm:"2"},{default:t(()=>[a(v,{color:"warning",disabled:!i.value,onClick:e[8]||(e[8]=l=>g.value=!1),class:"w-100"},{default:t(()=>e[21]||(e[21]=[u(" Cancel ")])),_:1},8,["disabled"])]),_:1}),a(c,{cols:"4",sm:"2"},{default:t(()=>[a(v,{color:"primary",disabled:!i.value,onClick:$,class:"w-100"},{default:t(()=>e[22]||(e[22]=[u(" Preview ")])),_:1},8,["disabled"])]),_:1}),a(c,{cols:"4",sm:"2",class:"text-right text-sm-left"},{default:t(()=>[a(v,{color:"success",disabled:!i.value,onClick:G,class:"w-100"},{default:t(()=>e[23]||(e[23]=[u(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1})],64)):C("",!0),a(Ue,{modelValue:P.value,"onUpdate:modelValue":e[10]||(e[10]=l=>P.value=l)},{actions:t(()=>[a(v,{variant:"text",onClick:e[9]||(e[9]=l=>P.value=!1)},{default:t(()=>e[24]||(e[24]=[u(" Close ")])),_:1})]),default:t(()=>[e[25]||(e[25]=u(" E-mail Sent "))]),_:1},8,["modelValue"])]))}});export{ge as C,qe as _,Ge as a,Ve as b,we as u};
