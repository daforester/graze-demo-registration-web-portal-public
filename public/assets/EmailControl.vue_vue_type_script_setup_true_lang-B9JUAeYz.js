import{_ as te,T as Q,u as se}from"./EmailEditor.vue_vue_type_script_setup_true_lang-DY_2d7Of.js";import{u as oe}from"./useConventionSlug-CvvvIpr0.js";import{i as Z,N as S,D as I,n as f,M as ue,r as n,C as ie,w as ne,A as g,h as a,H as O,l as w,q as t,G as N,v as d,Q as re,F as de,O as me,x as ve,U as fe,k as pe}from"./index-CvkjNnka.js";import{_ as Te}from"./ModelDialog.vue_vue_type_script_setup_true_lang-C0smcQmU.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as X}from"./forwardRefs-BAkGcvw1.js";import{V as H,a as v}from"./VRow-BVbB3nl7.js";import{V as Ee}from"./VSelect-DysUpBk7.js";import{V as U,o as Ve}from"./VGrid-DoGG6qmS.js";import{V as Ce,a as ge}from"./VAlert-C8ackDzF.js";import{V as ce}from"./VOverlay-BkkWmXqL.js";import{e as Ie,V as De,a as we,c as Ne}from"./VCard-CF5b4q-B.js";import{V as Se}from"./VList-DoEtow2A.js";import{V as be}from"./VSpacer-D562WWbA.js";import{V as j}from"./VTextField-Cey-gm2m.js";import{V as ye}from"./SaveButton.vue_vue_type_script_setup_true_lang-DNb6OpQx.js";var _e=(u=>(u.CHECK_IN_STATUS_PENDING="CHECK_IN_STATUS_PENDING",u.CHECK_IN_STATUS_COMPLETED="CHECK_IN_STATUS_COMPLETED",u.CHECK_IN_STATUS_REJECTED="CHECK_IN_STATUS_REJECTED",u.CHECK_IN_STATUS_REVOKED="CHECK_IN_STATUS_REVOKED",u))(_e||{});const Re=[{title:"Pending",value:"CHECK_IN_STATUS_PENDING"},{title:"Completed",value:"CHECK_IN_STATUS_COMPLETED"},{title:"Rejected",value:"CHECK_IN_STATUS_REJECTED"},{title:"Revoked",value:"CHECK_IN_STATUS_REVOKED"}],Xe=u=>{var p;return((p=Re.find(D=>D.value===u))==null?void 0:p.title)||""},ke=["innerHTML"],Me=Z({__name:"EmailPreviewWindow",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(u){const p=S(u,"modelValue");return(D,x)=>(f(),I("div",{innerHTML:p.value,class:"reset-styles"},null,8,ke))}}),Pe=Ue(Me,[["__scopeId","data-v-a08129c7"]]),Ae={class:"d-flex align-center justify-center",style:{width:"calc(100vw - 25px)",height:"100vh"}},Ze=Z({__name:"EmailControl",props:ue({modelType:{default:"user"},custom:{type:Boolean,default:!1}},{modelValue:{default:[]},modelModifiers:{},details:{required:!1},detailsModifiers:{},convention:{required:!1,default:void 0},conventionModifiers:{},organisation:{required:!1,default:void 0},organisationModifiers:{}}),emits:["update:modelValue","update:details","update:convention","update:organisation"],async setup(u){let p,D;const x=me(),{getEmailTemplateList:h}=se(),{getConvention:ee}=oe(),q=n([]),s=n(),b=S(u,"modelValue"),$=S(u,"details"),E=S(u,"convention");E.value||(E.value=([p,D]=ie(()=>ee()),p=await p,D(),p));const F=S(u,"organisation"),V=n(0),C=n([]),L=n(!1),y=n(!1),K=n(0),_=n(0),i=n([]),c=n(!1),R=n(""),k=n(""),M=n(""),P=n(""),A=n(!1),B=()=>{var o,e;h(Q.TARGET_TYPE_CONVENTION,((o=F.value)==null?void 0:o.OrganisationUUID)||null,((e=E.value)==null?void 0:e.ConventionUUID)||null).then(l=>{q.value=l})};ne(E,()=>{B()}),B();const G=(o,e=!1)=>{var r;const l={};return u.modelType=="registration"?l.RegistrationUUID=o:u.modelType=="submission"?l.SubmissionUUID=o:l.UserUUID=o,E.value&&(l.ConventionUUID=E.value.ConventionUUID),F.value&&(l.OrganisationUUID=F.value.OrganisationUUID),s.value&&(s.value.IsDefault?l.TemplateName=s.value.Name:((r=s.value)==null?void 0:r.EmailTemplateUUID)!==fe?l.TemplateUUID=s.value.EmailTemplateUUID:l.Template=s.value),e&&(l.Template=pe(s.value),l.TemplateUUID=void 0,l.TemplateName=void 0,l.Template&&(l.Template.HTML=M.value,l.Template.Subject=P.value,l.Template.From=R.value,l.Template.FromName=k.value)),l},J=()=>{C.value=[],b.value.forEach(o=>{const e=G(o,c.value);x.previewEmailTemplate(e).then(l=>{C.value.push(l)})}),V.value=0,L.value=!0};function le(o){return new Promise(e=>setTimeout(e,o))}const Y=async()=>{var o,e;y.value=!0,K.value=0,_.value=0,i.value=[];for(const l of b.value){const r=G(l,c.value);try{const m=await x.sendEmailTemplate(r);m.Errors.length>0&&m.Errors.forEach(T=>{i.value.push(T)})}catch(m){if(r.RegistrationUUID&&$.value&&$.value.length>0){const T=$.value.find(z=>{var W;return z.RegistrationUUID==r.RegistrationUUID||((W=z.registration)==null?void 0:W.RegistrationUUID)==r.RegistrationUUID});T?T.Reference?i.value.push(`Failed to send to: #${T.Reference} - ${T.Name}`):T.registration?i.value.push(`Failed to send to: #${T.registration.Reference||r.RegistrationUUID} - ${(e=(o=T.registration)==null?void 0:o.User)==null?void 0:e.DisplayName}`):i.value.push(`Failed to send to: UUID ${r.RegistrationUUID}`):i.value.push(`Failed to send to: UUID ${r.RegistrationUUID}`)}else i.value.push(`Failed to send to: UUID ${r.RegistrationUUID}`);m.ResponseCode==401||m.ResponseCode==403?i.value.push("Access Denied"):m.ResponseCode==400?i.value.push(`Bad request: ${m.ErrorMessage}`):m.ResponseCode==404?i.value.push(`Missing data: ${m.ErrorMessage}`):m.ResponseCode==500&&i.value.push(`Internal error: ${m.ErrorMessage}`)}await le(50),K.value+=1,_.value=K.value/b.value.length*100}y.value=!1,i.value.length===0&&(A.value=!0)},ae=async()=>{var o,e,l,r;M.value=((o=s.value)==null?void 0:o.HTML)||"",R.value=((e=s.value)==null?void 0:e.From)||"",k.value=((l=s.value)==null?void 0:l.FromName)||"",P.value=((r=s.value)==null?void 0:r.Subject)||"",c.value=!0};return(o,e)=>(f(),I("div",null,[b.value.length>0?(f(),I(O,{key:0},[a(H,null,{default:t(()=>[a(v,null,{default:t(()=>e[15]||(e[15]=[N("h2",null,"E-Mail",-1),N("p",null," Select an e-mail template to send bulk e-mails to selected registrations. You may preview what is sent before queuing it. ",-1)])),_:1})]),_:1}),c.value?g("",!0):(f(),w(H,{key:0},{default:t(()=>[a(v,{cols:"12",md:"6"},{default:t(()=>[a(Ee,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=l=>s.value=l),items:q.value,"item-value":l=>l,"item-title":"Title","hide-details":"",clearable:""},null,8,["modelValue","items","item-value"])]),_:1}),o.custom?(f(),w(v,{key:0,cols:"4",md:"2"},{default:t(()=>[a(U,{color:"warning",disabled:!s.value,onClick:ae,class:"w-100"},{default:t(()=>e[16]||(e[16]=[d(" Customise ")])),_:1},8,["disabled"])]),_:1})):g("",!0),a(v,{cols:"4",md:"2"},{default:t(()=>[a(U,{color:"primary",disabled:!s.value,onClick:J,class:"w-100"},{default:t(()=>e[17]||(e[17]=[d(" Preview ")])),_:1},8,["disabled"])]),_:1}),a(v,{cols:"4",md:"2",class:"text-right text-sm-left"},{default:t(()=>[a(U,{color:"success",disabled:!s.value,onClick:Y,class:"w-100"},{default:t(()=>e[18]||(e[18]=[d(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1})),i.value.length?(f(),w(Ce,{key:1,"border-color":"error",border:"start",class:"mt-4"},{default:t(()=>[a(ge,null,{default:t(()=>e[19]||(e[19]=[d("Errors Encountered")])),_:1}),(f(!0),I(O,null,re(i.value,l=>(f(),I("p",{key:l,class:"my-2"},ve(l),1))),128))]),_:1})):g("",!0),a(ce,{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=l=>y.value=l),"scroll-strategy":"block","location-strategy":"static","close-on-content-click":!1},{default:t(()=>[N("div",Ae,[e[22]||(e[22]=d(" > ")),a(Ie,{class:"ma-0",bordered:""},{default:t(()=>[a(De,null,{default:t(()=>[a(we,{class:"text-center"},{default:t(()=>e[20]||(e[20]=[N("small",null,"Sending Emails",-1)])),_:1})]),_:1}),a(Ne,{class:"text-center"},{default:t(()=>[a(Ve,{modelValue:_.value,"onUpdate:modelValue":e[1]||(e[1]=l=>_.value=l),color:"error",size:"60",width:"8"},null,8,["modelValue"]),e[21]||(e[21]=N("p",{class:"my-4"}," Navigating away will prevent emails from sending. ",-1)),i.value.length?(f(),w(Se,{key:0,items:i.value},null,8,["items"])):g("",!0)]),_:1})]),_:1})])]),_:1},8,["modelValue"]),a(Te,{modelValue:L.value,"onUpdate:modelValue":e[6]||(e[6]=l=>L.value=l),fullscreen:!1,"hide-details":!0,title:"Email Preview",scrollable:!0},{actions:t(()=>[a(X,null,{default:t(()=>[a(U,{color:"primary",disabled:V.value==0,onClick:e[3]||(e[3]=l=>V.value-=1)},{default:t(()=>e[23]||(e[23]=[d(" Previous ")])),_:1},8,["disabled"])]),_:1}),a(be),a(X,null,{default:t(()=>[a(U,{color:"primary",disabled:V.value==C.value.length-1,onClick:e[4]||(e[4]=l=>V.value+=1)},{default:t(()=>e[24]||(e[24]=[d(" Next ")])),_:1},8,["disabled"])]),_:1})]),default:t(()=>[C.value.length>0&&C.value[V.value]?(f(),w(Pe,{key:0,modelValue:C.value[V.value].HTML,"onUpdate:modelValue":e[5]||(e[5]=l=>C.value[V.value].HTML=l)},null,8,["modelValue"])):g("",!0)]),_:1},8,["modelValue"])],64)):g("",!0),c.value?(f(),I(O,{key:1},[a(H,null,{default:t(()=>[a(v,{cols:"12",lg:"4"},{default:t(()=>[a(j,{modelValue:P.value,"onUpdate:modelValue":e[7]||(e[7]=l=>P.value=l),label:"Custom Subject",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1}),a(v,{cols:"12",md:"6",lg:"4"},{default:t(()=>[a(j,{modelValue:k.value,"onUpdate:modelValue":e[8]||(e[8]=l=>k.value=l),label:"Custom From Name",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1}),a(v,{cols:"12",md:"6",lg:"4"},{default:t(()=>[a(j,{modelValue:R.value,"onUpdate:modelValue":e[9]||(e[9]=l=>R.value=l),label:"Custom From Email",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1}),a(te,{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=l=>M.value=l),convention:E.value,"onUpdate:convention":e[11]||(e[11]=l=>E.value=l),"owner-type":de(Q).TARGET_TYPE_CONVENTION},null,8,["modelValue","convention","owner-type"]),a(H,{class:"justify-end"},{default:t(()=>[a(v,{cols:"4",sm:"2"},{default:t(()=>[a(U,{color:"warning",disabled:!s.value,onClick:e[12]||(e[12]=l=>c.value=!1),class:"w-100"},{default:t(()=>e[25]||(e[25]=[d(" Cancel ")])),_:1},8,["disabled"])]),_:1}),a(v,{cols:"4",sm:"2"},{default:t(()=>[a(U,{color:"primary",disabled:!s.value,onClick:J,class:"w-100"},{default:t(()=>e[26]||(e[26]=[d(" Preview ")])),_:1},8,["disabled"])]),_:1}),a(v,{cols:"4",sm:"2",class:"text-right text-sm-left"},{default:t(()=>[a(U,{color:"success",disabled:!s.value,onClick:Y,class:"w-100"},{default:t(()=>e[27]||(e[27]=[d(" Send ")])),_:1},8,["disabled"])]),_:1})]),_:1})],64)):g("",!0),a(ye,{modelValue:A.value,"onUpdate:modelValue":e[14]||(e[14]=l=>A.value=l)},{actions:t(()=>[a(U,{variant:"text",onClick:e[13]||(e[13]=l=>A.value=!1)},{default:t(()=>e[28]||(e[28]=[d(" Close ")])),_:1})]),default:t(()=>[e[29]||(e[29]=d(" E-mail Sent "))]),_:1},8,["modelValue"])]))}});export{Re as C,Ze as _,Xe as a,_e as b};
